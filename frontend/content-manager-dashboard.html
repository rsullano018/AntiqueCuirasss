<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Manager Dashboard - Antique Cuirass</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/responsive.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dashboard-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .dashboard-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .nav-button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .nav-button:hover {
            background: #2980b9;
        }
        
        .nav-button.active {
            background: #e74c3c;
        }
        
        .dashboard-section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .dashboard-section.active {
            display: block;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .product-card h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .product-card p {
            margin: 5px 0;
            color: #7f8c8d;
        }
        
        .product-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .btn-edit, .btn-delete {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-edit {
            background: #3498db;
            color: white;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .form-actions {
            margin-top: 20px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .error-message {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .success-message {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        /* Image Upload Styles */
        .image-upload-container {
            margin-top: 10px;
        }
        
        .image-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
            background: #fafafa;
        }
        
        .image-upload-area:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }
        
        .image-upload-area.dragover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .upload-placeholder {
            color: #7f8c8d;
        }
        
        .upload-icon {
            font-size: 48px;
            display: block;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 12px;
            color: #95a5a6;
            margin: 5px 0 0 0;
        }
        
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .image-preview {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .image-preview img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        
        .image-preview .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-preview .remove-image:hover {
            background: #e74c3c;
        }
        
        .image-preview .image-info {
            padding: 5px;
            font-size: 11px;
            color: #7f8c8d;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Content Manager Dashboard</h1>
            <p>Manage products, categories, and content</p>
        </div>
        
        <div class="dashboard-nav">
            <button class="nav-button active" onclick="showSection('overview')">Overview</button>
            <button class="nav-button" onclick="showSection('products')">Products</button>
            <button class="nav-button" onclick="showSection('categories')">Categories</button>
            <button class="nav-button" onclick="logout()">Logout</button>
        </div>
        
        <!-- Overview Section -->
        <div id="overview-section" class="dashboard-section active">
            <h2>Overview</h2>
            <div id="message-container"></div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-products">-</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="featured-products">-</div>
                    <div class="stat-label">Featured Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-categories">-</div>
                    <div class="stat-label">Categories</div>
                </div>
            </div>
        </div>
        
        <!-- Products Section -->
        <div id="products-section" class="dashboard-section">
            <h2>Product Management</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn-primary" onclick="showAddProductForm()">Add New Product</button>
            </div>
            
            <div class="product-grid" id="products-grid">
                <!-- Products will be loaded here -->
            </div>
        </div>
        
        <!-- Categories Section -->
        <div id="categories-section" class="dashboard-section">
            <h2>Category Management</h2>
            <p>Category management features will be implemented here.</p>
        </div>
    </div>
    
    <!-- Add/Edit Product Modal -->
    <div id="product-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3 id="modal-title">Add Product</h3>
            <form id="product-form">
                <input type="hidden" id="product-id" value="">
                
                <div class="form-group">
                    <label for="product-name">Product Name *</label>
                    <input type="text" id="product-name" required>
                </div>
                
                <div class="form-group">
                    <label for="sku">SKU *</label>
                    <input type="text" id="sku" required>
                </div>
                
                <div class="form-group">
                    <label for="price">Price *</label>
                    <input type="number" id="price" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="original-price">Original Price</label>
                    <input type="number" id="original-price" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="short-description">Short Description *</label>
                    <textarea id="short-description" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="full-description">Full Description</label>
                    <textarea id="full-description" rows="5"></textarea>
                </div>
                
                <!-- Product Images Section -->
                <div class="form-group">
                    <label>Product Images</label>
                    <div class="image-upload-container">
                        <div class="image-upload-area" id="image-upload-area">
                            <div class="upload-placeholder">
                                <i class="upload-icon">ðŸ“·</i>
                                <p>Click to upload images or drag & drop</p>
                                <p class="upload-hint">Supports JPG, PNG, GIF (Max 5MB each)</p>
                            </div>
                            <input type="file" id="image-upload" multiple accept="image/*" style="display: none;">
                        </div>
                        <div class="image-preview-container" id="image-preview-container">
                            <!-- Image previews will be added here -->
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="category-id">Category *</label>
                    <select id="category-id" required>
                        <option value="">Select Category</option>
                        <!-- Categories will be loaded here -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="stock-quantity">Stock Quantity</label>
                    <input type="number" id="stock-quantity" min="0">
                </div>
                
                <div class="form-group">
                    <label for="condition-rating">Condition Rating (1-10)</label>
                    <input type="number" id="condition-rating" min="1" max="10">
                </div>
                
                <div class="form-group">
                    <label for="material">Material</label>
                    <input type="text" id="material">
                </div>
                
                <div class="form-group">
                    <label for="era-period">Era/Period</label>
                    <input type="text" id="era-period">
                </div>
                
                <div class="form-group">
                    <label for="manufacturer">Manufacturer</label>
                    <input type="text" id="manufacturer">
                </div>
                
                <div class="form-group">
                    <label for="year-manufactured">Year Manufactured</label>
                    <input type="number" id="year-manufactured" min="1800" max="2024">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="featured"> Featured Product
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="authenticity-verified"> Authenticity Verified
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save Product</button>
                    <button type="button" class="btn-secondary" onclick="closeProductModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="assets/js/api/api-client.js?v=202509190446"></script>
    <script>
        let currentUser = null;
        let products = [];
        let categories = [];
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initializeImageUpload();
        });
        
        async function checkAuth() {
            try {
                const response = await apiClient.getProfile();
                if (response.success) {
                    currentUser = response.data;
                    if (currentUser.Role !== 'content_manager' && currentUser.Role !== 'admin') {
                        showMessage('Access denied. Content manager privileges required.', 'error');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                        return;
                    }
                    loadOverview();
                } else {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'login.html';
            }
        }
        
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + '-section').classList.add('active');
            event.target.classList.add('active');
            
            // Load section data
            if (sectionName === 'products') {
                loadProducts();
            } else if (sectionName === 'categories') {
                loadCategories();
            }
        }
        
        async function loadOverview() {
            try {
                // Load products for stats
                const productsResponse = await apiClient.getProducts();
                if (productsResponse.success) {
                    products = productsResponse.data;
                    document.getElementById('total-products').textContent = products.length;
                    document.getElementById('featured-products').textContent = 
                        products.filter(p => p.Featured).length;
                }
                
                // Load categories for stats
                const categoriesResponse = await apiClient.getCategories();
                if (categoriesResponse.success) {
                    categories = categoriesResponse.data;
                    document.getElementById('total-categories').textContent = categories.length;
                }
            } catch (error) {
                showMessage('Error loading overview data: ' + error.message, 'error');
            }
        }
        
        async function loadProducts() {
            try {
                const response = await apiClient.getProducts();
                if (response.success) {
                    products = response.data;
                    renderProductsGrid();
                } else {
                    showMessage('Failed to load products: ' + response.error, 'error');
                }
            } catch (error) {
                showMessage('Error loading products: ' + error.message, 'error');
            }
        }
        
        function renderProductsGrid() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                const productImage = product.Images && product.Images.length > 0 
                    ? `<img src="${product.Images[0].dataUrl}" alt="${product.ProductName}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 4px; margin-bottom: 10px;">`
                    : `<div style="width: 100%; height: 150px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px; margin-bottom: 10px; color: #999;">No Image</div>`;
                
                card.innerHTML = `
                    ${productImage}
                    <h3>${product.ProductName}</h3>
                    <p><strong>SKU:</strong> ${product.SKU}</p>
                    <p><strong>Price:</strong> $${product.Price}</p>
                    <p><strong>Stock:</strong> ${product.StockQuantity || 0}</p>
                    <p><strong>Condition:</strong> ${product.ConditionRating || 'N/A'}/10</p>
                    <p><strong>Status:</strong> ${product.Status || 'Active'}</p>
                    ${product.Images && product.Images.length > 1 ? `<p><strong>Images:</strong> ${product.Images.length}</p>` : ''}
                    <div class="product-actions">
                        <button class="btn-edit" onclick="editProduct(${product.ProductID})">Edit</button>
                        <button class="btn-delete" onclick="deleteProduct(${product.ProductID})">Delete</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function showAddProductForm() {
            document.getElementById('modal-title').textContent = 'Add Product';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            clearImageUploads();
            loadCategoriesForSelect();
            document.getElementById('product-modal').style.display = 'block';
        }
        
        function editProduct(productId) {
            const product = products.find(p => p.ProductID == productId);
            if (!product) return;
            
            document.getElementById('modal-title').textContent = 'Edit Product';
            document.getElementById('product-id').value = product.ProductID;
            document.getElementById('product-name').value = product.ProductName || '';
            document.getElementById('sku').value = product.SKU || '';
            document.getElementById('price').value = product.Price || '';
            document.getElementById('original-price').value = product.OriginalPrice || '';
            document.getElementById('short-description').value = product.ShortDescription || '';
            document.getElementById('full-description').value = product.FullDescription || '';
            document.getElementById('category-id').value = product.CategoryID || '';
            document.getElementById('stock-quantity').value = product.StockQuantity || '';
            document.getElementById('condition-rating').value = product.ConditionRating || '';
            document.getElementById('material').value = product.Material || '';
            document.getElementById('era-period').value = product.EraPeriod || '';
            document.getElementById('manufacturer').value = product.Manufacturer || '';
            document.getElementById('year-manufactured').value = product.YearManufactured || '';
            document.getElementById('featured').checked = product.Featured || false;
            document.getElementById('authenticity-verified').checked = product.AuthenticityVerified || false;
            
            loadCategoriesForSelect();
            document.getElementById('product-modal').style.display = 'block';
        }
        
        function closeProductModal() {
            document.getElementById('product-modal').style.display = 'none';
            clearImageUploads();
        }
        
        async function loadCategoriesForSelect() {
            try {
                const response = await apiClient.getCategories();
                if (response.success) {
                    const select = document.getElementById('category-id');
                    select.innerHTML = '<option value="">Select Category</option>';
                    response.data.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.CategoryID;
                        option.textContent = category.CategoryName;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        document.getElementById('product-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productId = document.getElementById('product-id').value;
            const productData = {
                ProductName: document.getElementById('product-name').value,
                SKU: document.getElementById('sku').value,
                Price: parseFloat(document.getElementById('price').value),
                OriginalPrice: parseFloat(document.getElementById('original-price').value) || null,
                ShortDescription: document.getElementById('short-description').value,
                FullDescription: document.getElementById('full-description').value,
                CategoryID: parseInt(document.getElementById('category-id').value),
                StockQuantity: parseInt(document.getElementById('stock-quantity').value) || 0,
                ConditionRating: parseInt(document.getElementById('condition-rating').value) || null,
                Material: document.getElementById('material').value,
                EraPeriod: document.getElementById('era-period').value,
                Manufacturer: document.getElementById('manufacturer').value,
                YearManufactured: parseInt(document.getElementById('year-manufactured').value) || null,
                Featured: document.getElementById('featured').checked,
                AuthenticityVerified: document.getElementById('authenticity-verified').checked,
                Status: 'Active',
                Images: selectedImages.map(img => ({
                    filename: img.file.name,
                    dataUrl: img.dataUrl,
                    size: img.file.size,
                    type: img.file.type
                }))
            };
            
            try {
                let response;
                if (productId) {
                    response = await apiClient.updateProduct(productId, productData);
                } else {
                    response = await apiClient.createProduct(productData);
                }
                
                if (response.success) {
                    showMessage(productId ? 'Product updated successfully' : 'Product created successfully', 'success');
                    closeProductModal();
                    loadProducts();
                    loadOverview();
                } else {
                    showMessage('Error: ' + response.error, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        });
        
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }
            
            try {
                const response = await apiClient.deleteProduct(productId);
                if (response.success) {
                    showMessage('Product deleted successfully', 'success');
                    loadProducts();
                    loadOverview();
                } else {
                    showMessage('Error: ' + response.error, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        function loadCategories() {
            // Category management will be implemented here
            showMessage('Category management features coming soon!', 'info');
        }
        
        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            container.innerHTML = `<div class="${type}-message">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        async function logout() {
            try {
                await apiClient.logout();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'index.html';
            }
        }
        
        // Image Upload Functionality
        let selectedImages = [];
        
        function initializeImageUpload() {
            const uploadArea = document.getElementById('image-upload-area');
            const fileInput = document.getElementById('image-upload');
            const previewContainer = document.getElementById('image-preview-container');
            
            // Click to upload
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // File input change
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });
        }
        
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        }
        
        function handleFiles(files) {
            const validFiles = files.filter(file => {
                if (!file.type.startsWith('image/')) {
                    showMessage('Please select only image files', 'error');
                    return false;
                }
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showMessage('File size must be less than 5MB', 'error');
                    return false;
                }
                return true;
            });
            
            validFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        file: file,
                        dataUrl: e.target.result,
                        id: Date.now() + Math.random()
                    };
                    selectedImages.push(imageData);
                    displayImagePreview(imageData);
                };
                reader.readAsDataURL(file);
            });
        }
        
        function displayImagePreview(imageData) {
            const previewContainer = document.getElementById('image-preview-container');
            const preview = document.createElement('div');
            preview.className = 'image-preview';
            preview.innerHTML = `
                <img src="${imageData.dataUrl}" alt="Preview">
                <button class="remove-image" onclick="removeImage('${imageData.id}')">Ã—</button>
                <div class="image-info">${imageData.file.name}</div>
            `;
            previewContainer.appendChild(preview);
        }
        
        function removeImage(imageId) {
            selectedImages = selectedImages.filter(img => img.id !== imageId);
            updateImagePreviews();
        }
        
        function updateImagePreviews() {
            const previewContainer = document.getElementById('image-preview-container');
            previewContainer.innerHTML = '';
            selectedImages.forEach(imageData => {
                displayImagePreview(imageData);
            });
        }
        
        function clearImageUploads() {
            selectedImages = [];
            document.getElementById('image-preview-container').innerHTML = '';
            document.getElementById('image-upload').value = '';
        }
    </script>
</body>
</html>
